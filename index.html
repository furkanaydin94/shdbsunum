<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veri Kontrol ve Raporlama Aracı</title>

    <!-- Gerekli Kütüphaneler -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-accent: #3A6EA5;
            --background-body: #F4F6F9;
            --background-card: #FFFFFF;
            --text-primary: #1E214F;
            --text-secondary: #5a647e;
            --border-color: #e9ecef;
            --shadow-color: rgba(30, 33, 79, 0.06);
            --slide-transition-duration: 0.5s;
            --error-bg: #fff5f5;
            --error-border: #f5c6cb;
            --error-text: #721c24;
            --warning-bg: #fffbe6;
            --warning-border: #ffe58f;
            --warning-text: #8a6d3b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%;
            overflow: auto;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            background-color: var(--background-body);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; padding: 0 15px; }
        header {
            position: sticky; top: 0; z-index: 1000;
            background: linear-gradient(90deg, #3A6EA5 0%, #1E214F 100%);
            padding: 0.5rem 0;
            color: #ffffff;
            flex-shrink: 0;
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .logo-container img { height: 60px; display: block; }
        .horizontal-nav { flex-grow: 1; overflow: hidden; }
        .horizontal-nav ul {
            display: flex; flex-wrap: nowrap; overflow-x: auto;
            list-style: none; margin: 0; padding: 5px 0; gap: 0.1rem;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .horizontal-nav ul::-webkit-scrollbar { display: none; }
        .horizontal-nav a {
            color: rgba(255, 255, 255, 0.85); padding: 2px 5px;
            text-decoration: none; display: block; border-radius: 6px; transition: all 0.25s ease;
            font-size: 0.7rem; font-weight: 500; white-space: nowrap; cursor: pointer;
            border: 1px solid transparent;
        }
        .horizontal-nav a:hover { background-color: rgba(255, 255, 255, 0.1); color: #FFFFFF; }
        .horizontal-nav a.active-nav-link { background-color: rgba(255, 255, 255, 0.2); font-weight: 600; }
        main { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        #login-section {
            background-color: var(--background-card); padding: 2rem 3rem 3rem 3rem; border-radius: 16px;
            text-align: center; max-width: 450px; margin: 2rem auto;
            border: 1px solid var(--border-color); box-shadow: 0 8px 25px var(--shadow-color);
        }
        #login-section h2 { font-size: 1.8rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        #login-error { color: #e53e3e; margin-top: 1rem; font-weight: 500; }
        .entry-point-section {
            background-color: var(--background-card); padding: 2rem 3rem 3rem 3rem; border-radius: 16px;
            text-align: center; max-width: 650px; margin: 2rem auto;
            border: 1px solid var(--border-color); box-shadow: 0 8px 25px var(--shadow-color);
        }
        .entry-point-section h2 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-primary); }
        .entry-point-section p { color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6; }
        .button-group { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .action-btn { background-color: var(--primary-accent); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s ease; }
        .action-btn.secondary { background-color: var(--background-body); color: var(--text-primary); border: 1px solid var(--border-color); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #report-content { width: 100%; height: 100%; position: relative; }
        .presentation-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 1.5rem 0; opacity: 0; display: flex;
            justify-content: center; align-items: flex-start;
            overflow-y: auto; pointer-events: none;
            transition: opacity var(--slide-transition-duration) ease-in-out;
        }
        .presentation-slide.active-slide { opacity: 1; z-index: 10; pointer-events: auto; }
        .slide-content-wrapper {
            width: 95%; max-width: 1400px; background-color: var(--background-card);
            padding: 2rem; border-radius: 12px;
            box-shadow: 0 6px 20px var(--shadow-color); border: 1px solid var(--border-color);
        }
        .slide-header { 
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); 
        }
        .slide-header-text { flex-grow: 1; }
        .mudurluk-title { font-size: 1rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .hizmet-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .hizmet-description {
            font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.5rem;
            padding: 1rem; background-color: #f8f9fa;
            border-left: 4px solid var(--primary-accent); border-radius: 0 4px 4px 0;
            line-height: 1.6;
        }
        .hizmet-main-content { display: grid; gap: 1.5rem; }
        .hizmet-main-content.grid-with-map { grid-template-columns: 1.2fr 1fr; }
        .hizmet-main-content.no-map { display: flex; justify-content: center; }
        .hizmet-main-content.no-map .details-column { width: 100%; max-width: 800px; }
        .map-wrapper { 
            position: relative; border-radius: 12px; overflow: hidden; 
            border: 1px solid var(--border-color); transition: all 0.3s ease-in-out;
        }
        .map-container { width: 100%; height: 100%; min-height: 450px; background: #e9ecef; }
        .map-wrapper.fullscreen-map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 5000; border-radius: 0; border: none; }
        .details-column { display: flex; flex-direction: column; gap: 1.5rem; }
        .section-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .breakdown-card { background-color: var(--background-body); border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; transition: all 0.2s ease-in-out; }
        .breakdown-card:hover { border-color: var(--primary-accent); transform: translateY(-3px); }
        .breakdown-card h3 { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem; font-weight: 500; }
        .breakdown-card .card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            word-break: break-all;
        }
        .annual-data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .annual-data-table th, .annual-data-table td { padding: 0.6rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .annual-data-table th { font-weight: 600; color: var(--text-secondary); background-color: #f8f9fa; }
        .annual-data-table th:first-child, .annual-data-table td:first-child { text-align: left; }
        .hidden { display: none !important; }
        .presentation-controls { display: flex; align-items: center; gap: 0.75rem; }
        #fullscreen-btn { background: none; border: 1px solid rgba(255, 255, 255, 0.5); color: rgba(255, 255, 255, 0.85); width: 34px; height: 34px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        #fullscreen-btn:hover { background-color: rgba(255, 255, 255, 0.1); border-color: #fff; color: #fff; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-accent);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        .error-message {
            padding: 1.5rem;
            background-color: #fff5f5;
            border: 1px solid #f5c6cb;
            color: #721c24;
            border-radius: 8px;
            text-align: left;
        }
        .error-message h3 { margin-bottom: 0.5rem; }
        .error-message code {
            background-color: #f8d7da;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        #custom-context-menu {
            position: fixed;
            z-index: 10000;
            background-color: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 0.5rem 0;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .context-menu-item:hover {
            background-color: var(--background-body);
        }
        
        /* Veri Kontrol Aracı Stilleri */
        #data-checker-container {
            width: 100%;
            padding: 2rem;
            overflow: auto;
        }
        #data-checker-controls {
            background-color: var(--background-card);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        #data-checker-controls select, #data-checker-controls input {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        #data-table-container {
            max-height: 70vh;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        #data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--background-card);
        }
        #data-table th, #data-table td {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.85rem;
        }
        #data-table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
        }
        /* Compact görünüm: tüm sütunlar sığsın diye yazı ve dolgu küçültme */
        #data-checker-container.compact #data-table { table-layout: fixed; }
        #data-checker-container.compact #data-table th, 
        #data-checker-container.compact #data-table td { 
            padding: 6px 8px; 
            font-size: 0.78rem; 
            line-height: 1.4;
            white-space: nowrap;
        }
        /* Başlıkları tek satırda tut, veri hücrelerini sığması için sar */
        #data-checker-container.compact #data-table th { white-space: nowrap; }
        #data-checker-container.compact #data-table td { 
            white-space: normal; 
            overflow-wrap: anywhere; 
            word-break: break-word; 
        }
        /* Sayısal sütunları sağa hizala */
        #data-checker-container.compact #data-table td.col-yearly,
        #data-checker-container.compact #data-table td.col-monthly { text-align: right; }
        #data-checker-container.compact #data-table th:first-child, 
        #data-checker-container.compact #data-table td:first-child { max-width: 160px; overflow: hidden; text-overflow: ellipsis; }
        #data-checker-container.compact #data-table th:nth-child(2), 
        #data-checker-container.compact #data-table td:nth-child(2) { max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .risk-inconsistent { background-color: var(--error-bg); }
        .risk-decreasing { background-color: var(--warning-bg); }
        /* Tooltip'i tarayıcı title ile göstereceğiz; ::after kullanmayalım ki layout kaymasın */
        /* Alt grup satırı (Veri Aralığı) */
        #data-table .subgroup-row td { background-color: #f7f9fc; font-weight: 600; color: var(--text-secondary); }
        /* Grup satırı stili */
        #data-table .group-row td {
            background-color: #f2f6fb;
            font-weight: 600;
            color: var(--text-primary);
            border-top: 2px solid #dee2e6;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 1200px) { .hizmet-main-content.grid-with-map { grid-template-columns: 1fr; } }
        @media (max-width: 992px) { .navbar { flex-wrap: wrap; justify-content: center; gap: 1rem; } }
    </style>
</head>
<body>
    <header class="hidden">
        <div class="container navbar">
            <div class="logo-container">
                <img src="https://i.imgur.com/UUOeqIx.png" alt="Logo">
            </div>
            <nav class="horizontal-nav">
                <ul id="mudurluk-links"></ul>
            </nav>
            <div class="presentation-controls">
                <button id="fullscreen-btn" title="Tam Ekran">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div id="login-section">
            <h2>Giriş Yap</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Kullanıcı Adı</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Şifre</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="action-btn">Giriş Yap</button>
                <p id="login-error" class="hidden"></p>
            </form>
        </div>

        <div id="app-container" class="hidden">
            <div id="entry-point" class="entry-point-section">
                <!-- Bu alan JS tarafından doldurulacak -->
            </div>
        </div>

        <div id="report-content" class="hidden"></div>
        <div id="data-checker-container" class="hidden"></div>
    </main>
    
    <!-- Custom Context Menu -->
    <div id="custom-context-menu" class="hidden">
        <div class="context-menu-item" id="context-download-pdf">Raporu İndir (PDF)</div>
    </div>

    <script>
        // --- KULLANICI VERİLERİ ---
        const reportUsers = [
            { username: 'furkanaydin', password: '041295sD.', role: 'Admin' },
            { username: 'yönetici', password: 'shdb2025', role: 'Yönetici' },
            { username: 'kullanıcı', password: 'shdb2022', role: 'Kullanıcı' }
        ];

        // --- Global Değişkenler ---
        let bggVeriler = [], kumulatifVeriler = [];
        let serviceDescriptions = new Map();
        let istanbulGeoJSON;
        let mapInstances = {};
        let presentationSlides = [], currentSlideIndex = 0, isTransitioning = false;
        let rawDataForChecker = [];

        // --- DOM Elementleri ---
        const reportContent = document.getElementById('report-content');
        const entryPoint = document.getElementById('entry-point');
        const header = document.querySelector('header');
        const loginSection = document.getElementById('login-section');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const navLinksContainer = document.getElementById('mudurluk-links');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const contextMenu = document.getElementById('custom-context-menu');
        const dataCheckerContainer = document.getElementById('data-checker-container');

        // --- Yardımcı Fonksiyonlar ---
        const getDistrictName = (props) => {
            let name = props.name || props.AD || props.display_name || props['ilce_adi'] || (props.address && props.address.city_district) || null;
            if (name && typeof name === 'string') name = name.split(',')[0].trim();
            return name;
        };
        const formatNumber = (num) => (typeof num === 'number') ? num.toLocaleString('tr-TR') : 'N/A';
        const formatCurrency = (num) => (typeof num === 'number') ? num.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 0 }) : 'N/A';
        
        const excelDateToYear = (dateInput) => {
            if(typeof dateInput === 'number' && dateInput > 25569) {
                 return new Date(Math.round((dateInput - 25569) * 86400 * 1000)).getFullYear();
            }
            const date = new Date(dateInput);
            if (date instanceof Date && !isNaN(date)) { return date.getFullYear(); }
            return null;
        };

        const handleError = (message, details = '') => {
            console.error(message, details);
            const targetContainer = reportContent.classList.contains('hidden') ? dataCheckerContainer : reportContent;
            targetContainer.innerHTML = `<div class="error-message"><h3>Bir Sorun Oluştu</h3><p>${message}</p>${details ? `<p><strong>Teknik Detay:</strong> <code>${details}</code></p>` : ''}<p style="margin-top: 1rem;">Lütfen seçtiğiniz Excel dosyasının doğru formatta olduğundan ve gerekli sayfaları içerdiğinden emin olun.</p></div>`;
            targetContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            header.classList.add('hidden');
        };
        
        // --- SUNUM FONKSİYONLARI ---
        function showSlide(index) {
            if (index < 0 || index >= presentationSlides.length || index === currentSlideIndex || isTransitioning) return;
            isTransitioning = true;
            const outgoingSlide = presentationSlides[currentSlideIndex].element;
            const incomingSlide = presentationSlides[index].element;
            const activeNav = navLinksContainer.querySelector('.active-nav-link');
            if (activeNav) activeNav.classList.remove('active-nav-link');
            const newNavLink = navLinksContainer.querySelector(`[data-mudurluk-id="${presentationSlides[index].mudurlukId}"]`);
            if (newNavLink) newNavLink.classList.add('active-nav-link');
            outgoingSlide.classList.remove('active-slide');
            incomingSlide.classList.add('active-slide');
            currentSlideIndex = index;
            setTimeout(() => { isTransitioning = false; }, 500);
            const slideData = presentationSlides[index];
            if (slideData.mapId && !mapInstances[slideData.mapId]) {
                initializeMapForService(slideData.mapId, slideData.hizmet, slideData.haritaTur, slideData.mudurluk);
            } else if (slideData.mapId && mapInstances[slideData.mapId]) {
                setTimeout(() => mapInstances[slideData.mapId].invalidateSize(), 550);
            }
        }
        function changeSlide(direction) { showSlide(currentSlideIndex + direction); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } }
        function toggleMapFullscreen(mapId) {
            const wrapper = document.getElementById(`wrapper-${mapId}`);
            const map = mapInstances[mapId];
            if (!wrapper || !map) return;
            wrapper.classList.toggle('fullscreen-map');
            setTimeout(() => { map.invalidateSize(); }, 150);
        }

        // --- Veri Yükleme ve İşleme ---
        function handleFileProcessing(action) {
            const excelFile = document.getElementById('excel-file-input').files[0];

            if (!excelFile) {
                alert("Lütfen bir Excel dosyası seçin.");
                return;
            }

            appContainer.classList.add('hidden');
            const targetContainer = action === 'check' ? dataCheckerContainer : reportContent;
            targetContainer.innerHTML = '<div class="loading-spinner"></div>';
            targetContainer.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    if (action === 'check') {
                        const mainSheetName = workbook.SheetNames[0]; // İlk sayfayı ham veri olarak kabul et
                        const mainSheet = workbook.Sheets[mainSheetName];
                        if (!mainSheet) throw new Error(`Excel dosyasında okunacak bir sayfa bulunamadı.`);
                        rawDataForChecker = XLSX.utils.sheet_to_json(mainSheet, { defval: "" });
                        renderDataChecker();
                    } else {
                        const mainSheetName = "Hizmetler";
                        const descSheetName = "Açıklamalar";
                        const mainSheet = workbook.Sheets[mainSheetName];
                        const descSheet = workbook.Sheets[descSheetName];

                        if (!mainSheet) throw new Error(`Excel dosyasında "${mainSheetName}" isimli sayfa bulunamadı.`);
                        if (!descSheet) throw new Error(`Excel dosyasında "${descSheetName}" isimli sayfa bulunamadı.`);

                        const mainJsonData = XLSX.utils.sheet_to_json(mainSheet);
                        const descriptionsJsonData = XLSX.utils.sheet_to_json(descSheet);
                        
                        processAndRenderReport(mainJsonData, descriptionsJsonData);
                    }
                } catch (err) {
                    handleError("Excel dosyası okunurken veya işlenirken bir hata oluştu.", err.message);
                }
            };
            reader.onerror = function(error) {
                handleError("Dosya okunurken bir hata oluştu.", error);
            };
            reader.readAsArrayBuffer(excelFile);
        }
        
        function processAndRenderReport(mainJsonData, descriptionsJsonData, onComplete) {
            try {
                Object.values(mapInstances).forEach(map => map.remove());
                mapInstances = {};
                reportContent.innerHTML = ''; 
                presentationSlides = [];
                currentSlideIndex = 0;
                
                serviceDescriptions.clear();
                if (descriptionsJsonData) {
                    descriptionsJsonData.forEach(row => {
                          const hizmet = row['Hizmet Başlığı']?.trim();
                          const aciklama = row['Açıklama']?.trim();
                          if (hizmet && aciklama) {
                              serviceDescriptions.set(hizmet, aciklama);
                          }
                    });
                }

                if (!mainJsonData || mainJsonData.length === 0) { throw new Error("Ana veri sayfasından veri okunamadı veya sayfa boş."); }
                
                const cleanedData = mainJsonData.map(row => ({
                    mudurluk: row['Müdürlük']?.trim() || null, hizmet: row['Hizmet Başlığı']?.trim() || null,
                    tur: row['Tür']?.trim() || null, lokasyon: row['Lokasyon']?.trim() || null,
                    veriAraligi: row['Veri Aralığı']?.toString().trim() || null, 
                    deger: parseFloat(row['Değer']) || 0,
                    sonTarih: row['Son Tarih'],
                })).filter(row => row.mudurluk && row.hizmet && row.veriAraligi);

                bggVeriler = cleanedData.filter(row => row.veriAraligi?.toLocaleUpperCase('tr-TR') === 'BGG');
                kumulatifVeriler = cleanedData.filter(row => row.veriAraligi?.toLocaleUpperCase('tr-TR') === 'KÜMÜLATİF');

                if (bggVeriler.length === 0) { throw new Error('Dosyada "Veri Aralığı" sütununda "BGG" olan geçerli veri bulunamadı.'); }
                
                fetch('https://raw.githubusercontent.com/sahircansurmeli/istanbul-geojson/master/ilce_geojson.json')
                    .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.json(); })
                    .then(geojsonData => { 
                        istanbulGeoJSON = geojsonData; 
                        renderFullReport(); 
                        if (onComplete) {
                            setTimeout(onComplete, 1000);
                        }
                    })
                    .catch(err => { handleError("Harita verisi (GeoJSON) yüklenirken bir hata oluştu.", err.message); });
            } catch (err) {
                handleError("Veriler işlenirken bir hata oluştu.", err.message);
            }
        }

        // --- Başlangıç ve Kullanıcı Yönetimi ---
        function renderEntryPoint() {
            entryPoint.innerHTML = `
                <h2>İşlem Seçin</h2>
                <p>Ham veriyi kontrol etmek veya hazır rapor dosyasını yükleyerek sunumu görüntülemek için bir işlem seçin.</p>
                <div class="button-group">
                    <button id="check-data-btn" class="action-btn secondary">Veri Kontrol Aracı</button>
                    <button id="view-report-btn" class="action-btn">Rapor Görüntüleyici</button>
                    <button id="prepare-report-btn" class="action-btn">Rapor Dosyası Hazırlama</button>
                </div>
            `;
            document.getElementById('check-data-btn').addEventListener('click', () => renderFileUploader('check'));
            document.getElementById('view-report-btn').addEventListener('click', () => renderFileUploader('view'));
            document.getElementById('prepare-report-btn').addEventListener('click', () => renderPrepareUploader());
        }
        
        function renderFileUploader(mode) {
            const title = mode === 'check' ? 'Ham Veri Dosyasını Yükle' : 'Hazır Rapor Dosyasını Yükle';
            const description = mode === 'check' 
                ? 'Lütfen kontrol etmek istediğiniz ham veriyi içeren Excel dosyasını seçin.'
                : 'Lütfen raporu oluşturmak için gerekli "Hizmetler" ve "Açıklamalar" sayfalarını içeren Excel dosyasını seçin.';
            
            entryPoint.innerHTML = `
                <h2>${title}</h2>
                <p>${description}</p>
                <div class="form-group" style="margin-top: 2rem;">
                    <label for="excel-file-input">Excel Dosyası (.xlsx)</label>
                    <input type="file" id="excel-file-input" accept=".xlsx, .xls" required style="padding: 10px; border: 1px solid var(--border-color); width: 100%; border-radius: 8px;">
                </div>
                <div class="button-group">
                    <button id="process-file-btn" class="action-btn">Dosyayı İşle</button>
                    <button id="back-to-main-btn" class="action-btn secondary">Geri</button>
                </div>
            `;
            document.getElementById('process-file-btn').addEventListener('click', () => handleFileProcessing(mode));
            document.getElementById('back-to-main-btn').addEventListener('click', renderEntryPoint);
        }

        // --- RAPOR DOSYASI HAZIRLAMA ---
        let shdbTemplateFilters = { hizmetler: [] };
        let firstExcelRaw = [];
        let secondWorkbook = null;
        function renderPrepareUploader() {
            entryPoint.innerHTML = `
                <h2>Rapor Dosyası Hazırlama</h2>
                <p>1) Ham Excel (Veri Kontrol’le aynı şema)
                   2) Şablon Excel (Sayfalar: SHDB Taslak, Açıklamalar, Özet, Merkezler)</p>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>1. Excel (Ham Veri)</label>
                    <input type="file" id="prep-file-raw" accept=",.xlsx,.xls" />
                </div>
                <div class="form-group">
                    <label>2. Excel (Şablon)</label>
                    <input type="file" id="prep-file-template" accept=",.xlsx,.xls" />
                </div>
                <div class="button-group">
                    <button id="prep-process" class="action-btn">Dosyaları Yükle</button>
                    <button id="back-to-main-btn" class="action-btn secondary">Geri</button>
                </div>
                <div id="prep-pivot-container" style="margin-top:1rem;"></div>
            `;
            document.getElementById('back-to-main-btn').addEventListener('click', renderEntryPoint);
            document.getElementById('prep-process').addEventListener('click', handlePrepareLoad);
        }

        function handlePrepareLoad() {
            const fileRaw = document.getElementById('prep-file-raw').files[0];
            const fileTpl = document.getElementById('prep-file-template').files[0];
            if (!fileRaw || !fileTpl) { alert('Her iki dosyayı da seçin.'); return; }

            const r1 = new FileReader();
            r1.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const mainSheetName = wb.SheetNames[0];
                    const mainSheet = wb.Sheets[mainSheetName];
                    firstExcelRaw = XLSX.utils.sheet_to_json(mainSheet, { defval: '' });
                    loadSecond();
                } catch(err) {
                    handleError('Ham dosya okunamadı.', err.message);
                }
            };
            r1.readAsArrayBuffer(fileRaw);

            function loadSecond() {
                const r2 = new FileReader();
                r2.onload = (e2) => {
                    try {
                        secondWorkbook = XLSX.read(new Uint8Array(e2.target.result), { type: 'array' });
                        renderShdbPivot();
                    } catch(err) {
                        handleError('Şablon dosyası okunamadı.', err.message);
                    }
                };
                r2.readAsArrayBuffer(fileTpl);
            }
        }

        function trNormalize(str) {
            return (str||'')
                .toString()
                .trim()
                .toLowerCase()
                .replace(/\s+/g,' ')
                .replace(/[ç]/g,'c').replace(/[ğ]/g,'g').replace(/[ıiİ]/g,'i').replace(/[ö]/g,'o').replace(/[ş]/g,'s').replace(/[ü]/g,'u');
        }
        function getSheetByNamesInsensitive(wb, candidates) {
            const map = new Map();
            wb.SheetNames.forEach(n => map.set(trNormalize(n), n));
            for (const c of candidates) {
                const key = trNormalize(c);
                if (map.has(key)) return wb.Sheets[map.get(key)];
            }
            // Fallback: contains check (e.g., extra spaces)
            for (const n of wb.SheetNames) {
                const k = trNormalize(n);
                if (k.includes(trNormalize('shdb taslak'))) return wb.Sheets[n];
            }
            return null;
        }
        function renderShdbPivot() {
            const sheet = getSheetByNamesInsensitive(secondWorkbook, ['SHDB Taslak','Shdb Taslak','shdb taslak']);
            if (!sheet) {
                handleError('Şablonda SHDB Taslak sayfası bulunamadı.');
                return;
            }
            // Yükleme panelini gizle; sadece pivot ve Paketle butonu görünsün
            try { entryPoint.classList.add('hidden'); } catch(e) {}
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
            // SHDB Taslak’tan filtre alanlarını topla (Müdürlük, Hizmet Başlığı, Tür, Veri Aralığı)
            const wanted = rows.map(r => ({
                mudurluk: (r['Müdürlük']||'').toString().trim(),
                hizmet: (r['Hizmet Başlığı']||'').toString().trim(),
                tur: (r['Tür']||'').toString().trim(),
                veriAraligi: (r['Veri Aralığı']||'').toString().trim().toLocaleUpperCase('tr-TR')
            })).filter(x => x.mudurluk && x.hizmet && x.tur && x.veriAraligi);

            // Ham veriyi normalize et ve SHDB Taslak’ta geçenlerle filtrele
            const normalized = firstExcelRaw.map(row => ({
                mudurluk: (row['Müdürlük']||'').toString().trim(),
                hizmet: (row['Hizmet Başlığı']||'').toString().trim(),
                tur: (row['Tür']||'').toString().trim(),
                lokasyon: (row['Lokasyon']||'').toString().trim(),
                veriAraligi: (row['Veri Aralığı']||'').toString().trim().toLocaleUpperCase('tr-TR'),
                deger: parseFloat(row['Değer']) || 0,
                sonTarih: row['Son Tarih']
            })).filter(r => wanted.some(w => w.mudurluk===r.mudurluk && w.hizmet===r.hizmet && w.tur===r.tur && w.veriAraligi===r.veriAraligi));

            // Veri Kontrol Aracı görünümünü yeniden kullan: geçici olarak rawDataForChecker ve renderDataChecker ile
            rawDataForChecker = normalized.map(n => ({
                'Müdürlük': n.mudurluk,
                'Hizmet Başlığı': n.hizmet,
                'Tür': n.tur,
                'Lokasyon': n.lokasyon,
                'Veri Aralığı': n.veriAraligi,
                'Değer': n.deger,
                'Son Tarih': n.sonTarih
            }));

            // Pivotu göster (mevcut tablo) ve üstte Paketle düğmesini ekle
            dataCheckerContainer.classList.remove('hidden');
            document.getElementById('prep-pivot-container').innerHTML = '';
            renderDataChecker();

            // Üste tek bir buton koy: tıklandığında ay seçimi alanı ve Paketle çağrısı açılsın
            const ctrlBar = document.createElement('div');
            ctrlBar.style.display = 'flex';
            ctrlBar.style.justifyContent = 'flex-end';
            ctrlBar.style.gap = '10px';
            ctrlBar.style.margin = '10px 0';
            ctrlBar.innerHTML = `
                <button id="prep-open-package" class="action-btn">Paketle</button>
                <div id="prep-package-panel" class="hidden" style="display:flex;align-items:center;gap:10px;">
                    <label>Paketlenecek Ay</label>
                    <input type="month" id="package-month" />
                    <button id="do-package" class="action-btn">Oluştur</button>
                </div>
            `;
            dataCheckerContainer.insertAdjacentElement('afterbegin', ctrlBar);
            document.getElementById('prep-open-package').addEventListener('click', () => {
                document.getElementById('prep-package-panel').classList.toggle('hidden');
                const pnl = document.getElementById('prep-package-panel');
                pnl.style.display = pnl.classList.contains('hidden') ? 'none' : 'flex';
            });
            document.getElementById('do-package').addEventListener('click', () => doPackageFull(firstExcelRaw, rows));
        }

        function isDateHeader(h) { return /tarih/i.test(h); }

        function toJsDate(v) {
            if (v === undefined || v === null || v === '') return '';
            if (typeof v === 'number') { // Excel serial
                const epoch = new Date(Math.round((v - 25569) * 86400 * 1000));
                return isNaN(epoch) ? '' : epoch;
            }
            const d = new Date(v);
            return isNaN(d) ? '' : d;
        }

        // Paketle: tüm sütunlar korunsun; sadece SHDB Taslak seçimlerine uyan satırlar kalsın
        function doPackageFull(allRawRows, templateRows) {
            const monthVal = document.getElementById('package-month').value; // yyyy-mm
            if (!monthVal) { alert('Ay seçin'); return; }
            const [yy, mm] = monthVal.split('-');
            const targetYear = parseInt(yy, 10);
            const targetMonthIndex = parseInt(mm, 10) - 1; // 0..11

            // SHDB Taslak seçim seti
            const wanted = templateRows.map(r => ({
                mudurluk: (r['Müdürlük']||'').toString().trim(),
                hizmet: (r['Hizmet Başlığı']||'').toString().trim(),
                tur: (r['Tür']||'').toString().trim(),
                veriAraligi: (r['Veri Aralığı']||'').toString().trim().toLocaleUpperCase('tr-TR')
            })).filter(x => x.mudurluk && x.hizmet && x.tur && x.veriAraligi);

            const isWanted = (row) => wanted.some(w =>
                w.mudurluk === (row['Müdürlük']||'').toString().trim() &&
                w.hizmet === (row['Hizmet Başlığı']||'').toString().trim() &&
                w.tur === (row['Tür']||'').toString().trim() &&
                w.veriAraligi === ((row['Veri Aralığı']||'').toString().trim().toLocaleUpperCase('tr-TR'))
            );

            const monthFilter = (row) => {
                const d = row['Son Tarih'] || row['İlk Tarih'] || row['SonTarih'] || row['Son tarih'];
                const jsd = toJsDate(d);
                if (!jsd) return false;
                const y = jsd.getFullYear();
                const m = jsd.getMonth();
                return (y < targetYear) || (y === targetYear && m === targetMonthIndex);
            };

            // Seçim + ay filtresi
            let filtered = allRawRows.filter(r => isWanted(r) && monthFilter(r));
            // Değeri 0 olan satırları çıkar
            filtered = filtered.filter(r => {
                const val = r['Değer'];
                const num = typeof val === 'string' ? parseFloat(val.replace(/[^0-9.-]/g,'')) : (val || 0);
                return !isNaN(num) && num !== 0;
            });

            // Tarih sütunlarını JS Date'e çevir (Excel’de date türüne yazacağız)
            const headers = Object.keys(allRawRows[0] || {});
            const outRows = filtered.map(r => {
                const o = {};
                headers.forEach(h => {
                    o[h] = isDateHeader(h) ? toJsDate(r[h]) : r[h];
                });
                return o;
            });

            const wbOut = XLSX.utils.book_new();
            const wsHizmetler = XLSX.utils.json_to_sheet(outRows, { cellDates: true });
            XLSX.utils.book_append_sheet(wbOut, wsHizmetler, 'Hizmetler');

            // Diğer sayfaları aynen ekle (adları esnek eşleştirme)
            const copyByName = (cands, outName) => {
                const s = getSheetByNamesInsensitive(secondWorkbook, cands);
                if (s) {
                    const aoa = XLSX.utils.sheet_to_json(s, { header: 1, raw: true });
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    XLSX.utils.book_append_sheet(wbOut, ws, outName);
                }
            };
            copyByName(['Açıklamalar','Aciklamalar'], 'Açıklamalar');
            copyByName(['Özet','Ozet'], 'Özet');
            copyByName(['Merkezler'], 'Merkezler');

            XLSX.writeFile(wbOut, `paket-${monthVal}.xlsx`, { cellDates: true });
        }

        function renderFullReport() {
            appContainer.classList.add('hidden');
            reportContent.classList.remove('hidden');
            header.classList.remove('hidden');

            const mudurlukler = [...new Set(bggVeriler.map(item => item.mudurluk))];
            navLinksContainer.innerHTML = '';
            let mapIndex = 0;
            mudurlukler.forEach(mudurlukAdi => {
                const mudurlukId = 'mudurluk-' + mudurlukAdi.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase();
                const hizmetler = [...new Set(bggVeriler.filter(v => v.mudurluk === mudurlukAdi).map(item => item.hizmet))];
                const navListItem = document.createElement('li');
                const navLink = document.createElement('a');
                navLink.textContent = mudurlukAdi;
                navLink.dataset.mudurlukId = mudurlukId;
                navLink.addEventListener('click', () => { const firstSlideIndex = presentationSlides.findIndex(s => s.mudurlukId === mudurlukId); if (firstSlideIndex !== -1) showSlide(firstSlideIndex); });
                navListItem.appendChild(navLink);
                navLinksContainer.appendChild(navListItem);
                hizmetler.forEach(hizmetAdi => {
                    const slideElement = document.createElement('div');
                    slideElement.className = 'presentation-slide';
                    const bggHizmetData = bggVeriler.filter(v => v.mudurluk === mudurlukAdi && v.hizmet === hizmetAdi);
                    const kirilimlar = [...new Set(bggHizmetData.map(item => item.tur))].filter(Boolean);
                    if (kirilimlar.length === 0) return;
                    const ilceVerisiVarMi = bggHizmetData.some(d => d.lokasyon && d.lokasyon.trim() !== "İstanbul Geneli" && d.lokasyon.trim() !== "Diğer");
                    let haritaIcinTur = ilceVerisiVarMi ? kirilimlar[0] : null;
                    const mapId = `map-${mapIndex++}`;
                    let breakdownGridHTML = '';
                    kirilimlar.forEach(kirilimAdi => {
                        const toplamDeger = bggHizmetData.filter(item => item.tur === kirilimAdi).reduce((sum, item) => sum + (item.deger || 0), 0);
                        const cardValue = kirilimAdi.toLowerCase().includes('bütçe') ? formatCurrency(toplamDeger) : formatNumber(toplamDeger);
                        breakdownGridHTML += `<div class="breakdown-card"><h3>${kirilimAdi}</h3><div class="card-value">${cardValue}</div></div>`;
                    });
                    
                    const annualTableHTML = createAnnualDataTable(hizmetAdi, mudurlukAdi, kirilimlar);
                    
                    const mapHTML = ilceVerisiVarMi ? `<div class="map-wrapper" id="wrapper-${mapId}"><div class="map-container" id="${mapId}"></div></div>` : '';
                    const descriptionHTML = serviceDescriptions.has(hizmetAdi) ? `<div class="hizmet-description">${serviceDescriptions.get(hizmetAdi)}</div>` : '';

                    slideElement.innerHTML = `<div class="slide-content-wrapper"><div class="slide-header"><div class="slide-header-text"><h2 class="mudurluk-title">${mudurlukAdi}</h2><h1 class="hizmet-title">${hizmetAdi}</h1></div></div>${descriptionHTML}<div class="hizmet-main-content ${ilceVerisiVarMi ? 'grid-with-map' : 'no-map'}">${mapHTML}<div class="details-column"><div><h3 class="section-title">Genel Veriler</h3><div class="breakdown-grid">${breakdownGridHTML}</div></div>${annualTableHTML}</div></div></div>`;
                    reportContent.appendChild(slideElement);
                    presentationSlides.push({ element: slideElement, mudurlukId, mapId: ilceVerisiVarMi ? mapId : null, haritaTur: haritaIcinTur, mudurluk: mudurlukAdi, hizmet: hizmetAdi, kirilimlar: kirilimlar });
                });
            });
            if(presentationSlides.length > 0) {
                 presentationSlides[0].element.classList.add('active-slide');
                 const firstNavLink = navLinksContainer.querySelector(`[data-mudurluk-id="${presentationSlides[0].mudurlukId}"]`);
                 if(firstNavLink) firstNavLink.classList.add('active-nav-link');
                 const firstSlide = presentationSlides[0];
                 if(firstSlide.mapId) { initializeMapForService(firstSlide.mapId, firstSlide.hizmet, firstSlide.haritaTur, firstSlide.mudurluk); }
            }
        }
        
        function createAnnualDataTable(hizmetAdi, mudurlukAdi, genelVeriSiralama) {
            const hizmetKumulatifData = kumulatifVeriler.filter(d => d.hizmet === hizmetAdi && d.mudurluk === mudurlukAdi);
            if (hizmetKumulatifData.length === 0) return '';
            
            const mevcutYillikTurler = [...new Set(hizmetKumulatifData.map(d => d.tur))];
            const yillikTurler = genelVeriSiralama.filter(tur => mevcutYillikTurler.includes(tur));

            const yillikVeri = {};
            hizmetKumulatifData.forEach(row => {
                const year = excelDateToYear(row.sonTarih);
                if (!year) return;
                if (!yillikVeri[year]) yillikVeri[year] = { year: year };
                yillikVeri[year][row.tur] = (yillikVeri[year][row.tur] || 0) + row.deger;
            });
            const tableData = Object.values(yillikVeri).sort((a, b) => a.year - b.year);
            if (tableData.length === 0) return '';
            let tableHTML = `<div><h3 class="section-title">Yıllık Veriler</h3><table class="annual-data-table"><thead><tr><th>Yıl</th>${yillikTurler.map(tur => `<th>${tur}</th>`).join('')}</tr></thead><tbody>${tableData.map(rowData => `<tr><td>${rowData.year}</td>${yillikTurler.map(tur => `<td>${(tur.toLowerCase().includes('bütçe') ? formatCurrency(rowData[tur]) : formatNumber(rowData[tur])) || '0'}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            return tableHTML;
        }

        function initializeMapForService(mapId, hizmetAdi, tur, mudurlukAdi) {
            const mapContainer = document.getElementById(mapId);
            if (!mapContainer || mapContainer._leaflet_id || !tur) return;
            const map = L.map(mapId, { zoomControl: false, attributionControl: false, preferCanvas: true }).setView([41.08, 29.00], 9);
            mapInstances[mapId] = map;
            map.on('dblclick', () => toggleMapFullscreen(mapId));
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png').addTo(map);
            const filteredData = bggVeriler.filter(item => item.mudurluk === mudurlukAdi && item.hizmet === hizmetAdi && item.tur === tur);
            const ilceData = filteredData.filter(item => item.lokasyon && item.lokasyon.trim() !== "İstanbul Geneli" && item.lokasyon.trim() !== "Diğer");
            const localMapData = {};
            ilceData.forEach(item => { if (item.lokasyon) localMapData[item.lokasyon] = (localMapData[item.lokasyon] || 0) + item.deger; });
            const values = Object.values(localMapData);
            const localValueRange = { min: values.length ? Math.min(...values) : 0, max: values.length ? Math.max(...values) : 0 };
            const dynamicStyle = (feature) => ({ fillColor: getColor(localMapData[getDistrictName(feature.properties)], localValueRange), weight: 1.5, opacity: 1, color: '#ffffff', fillOpacity: 0.85 });
            const geojsonLayer = L.geoJson(istanbulGeoJSON, {
                style: dynamicStyle,
                onEachFeature: (feature, layer) => {
                    layer.on({
                        mouseover: (e) => { const districtName = getDistrictName(feature.properties); const value = localMapData[districtName]; const content = `<strong>${districtName}</strong><br>${tur}: ${formatNumber(value)}`; layer.bindTooltip(content, { sticky: true }).openTooltip(); e.target.setStyle({ weight: 2.5, color: '#343a40', fillOpacity: 1 }).bringToFront(); },
                        mouseout: (e) => { geojsonLayer.resetStyle(e.target); layer.closeTooltip(); },
                        click: (e) => map.fitBounds(e.target.getBounds())
                    });
                }
            }).addTo(map);
        }
        const getColor = (value, range) => {
            if (typeof value !== 'number') return '#dee2e6';
            const { min, max } = range;
            if (max <= min) return '#8ab5e1';
            const ratio = (value - min) / (max - min);
            if (ratio > 0.8) return '#3A6EA5'; if (ratio > 0.6) return '#5c86b8'; if (ratio > 0.4) return '#8ab5e1'; if (ratio > 0.2) return '#acc8e8'; return '#d0e0f3';
        };

        // --- VERİ KONTROL ARACI (PIVOT VE HATA TESPİT) ---
        function renderDataChecker() {
            try {
                if (!rawDataForChecker || rawDataForChecker.length === 0) {
                    handleError('Ham veri bulunamadı veya sayfa boş.');
                    return;
                }

                // Ham veriyi normalize et
                const normalized = rawDataForChecker.map(row => ({
                    mudurluk: (row['Müdürlük'] || '').toString().trim(),
                    hizmet: (row['Hizmet Başlığı'] || '').toString().trim(),
                    tur: (row['Tür'] || '').toString().trim(),
                    lokasyon: (row['Lokasyon'] || '').toString().trim(),
                    veriAraligi: (row['Veri Aralığı'] || '').toString().trim().toLocaleUpperCase('tr-TR'),
                    deger: parseFloat(row['Değer']) || 0,
                    sonTarih: row['Son Tarih']
                })).filter(r => r.hizmet && r.tur && r.veriAraligi);

                // Yardımcılar
                const monthNames = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];
                const toJSDate = (dateInput) => {
                    if (typeof dateInput === 'number' && dateInput > 25569) {
                        return new Date(Math.round((dateInput - 25569) * 86400 * 1000));
                    }
                    const d = new Date(dateInput);
                    return (d instanceof Date && !isNaN(d)) ? d : null;
                };
                const getYear = (v) => excelDateToYear(v);
                const getMonthIndex = (v) => { const d = toJSDate(v); return d ? d.getMonth() : null; };

                // Yılları çıkar ve son yılı belirle
                const allYearsSet = new Set();
                normalized.forEach(r => { const y = getYear(r.sonTarih); if (y) allYearsSet.add(y); });
                const yearsSorted = Array.from(allYearsSet).sort((a,b) => a-b);
                if (yearsSorted.length === 0) { handleError('Tarihlerden yıl bilgisi üretilemedi.'); return; }
                const lastYear = Math.max(...yearsSorted);
                const yearlyYears = yearsSorted.filter(y => y < lastYear);

                // Son yılda veri olan son ayı bul (yalnızca Değer hücresi DOLU olanlar dikkate alınır)
                let lastMonthWithData = null; // 0..11
                rawDataForChecker.forEach(row => {
                    const y = getYear(row['Son Tarih']);
                    if (y !== lastYear) return;
                    const m = getMonthIndex(row['Son Tarih']);
                    if (m === null) return;
                    const rawDeger = row['Değer'];
                    const hasValue = !(rawDeger === undefined || rawDeger === null || (typeof rawDeger === 'string' && rawDeger.trim() === ''));
                    if (hasValue) {
                        if (lastMonthWithData === null || m > lastMonthWithData) lastMonthWithData = m;
                    }
                });

                // Filtre seçenekleri
                const hizmetOptions = Array.from(new Set(normalized.map(r => r.hizmet))).sort();
                const mudurlukOptions = Array.from(new Set(normalized.map(r => r.mudurluk).filter(Boolean))).sort();
                const lokasyonOptions = Array.from(new Set(normalized.map(r => r.lokasyon).filter(Boolean))).sort();

                // Arayüz
                dataCheckerContainer.classList.remove('hidden');
                reportContent.classList.add('hidden');
                header.classList.add('hidden');
                dataCheckerContainer.classList.add('compact');
                dataCheckerContainer.innerHTML = `
                    <div id="data-checker-controls">
                        <label>Hizmet: 
                            <select id="filter-hizmet">
                                <option value="">Tümü</option>
                                ${hizmetOptions.map(h => `<option value="${h.replace(/"/g,'&quot;')}">${h}</option>`).join('')}
                            </select>
                        </label>
                        <label>Müdürlük: 
                            <select id="filter-mudurluk">
                                <option value="">Tümü</option>
                                ${mudurlukOptions.map(m => `<option value="${m.replace(/"/g,'&quot;')}">${m}</option>`).join('')}
                            </select>
                        </label>
                        <label>Lokasyon: 
                            <select id="filter-lokasyon">
                                <option value="">Tümü</option>
                                ${lokasyonOptions.map(l => `<option value="${l.replace(/"/g,'&quot;')}">${l}</option>`).join('')}
                            </select>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="filter-only-errors" /> Sadece Hatalı Olanları Göster
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="toggle-yearly" checked /> Yıllık Sütunları Göster
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="toggle-monthly" checked /> Aylık Sütunları Göster
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="toggle-error-col" checked /> Hata Açıklaması
                        </label>
                    </div>
                    <div id="data-table-container">
                        <table id="data-table">
                            <thead id="data-table-head"></thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                `;

                // Başlık
                const thead = dataCheckerContainer.querySelector('#data-table-head');
                thead.innerHTML = `<tr>
                    <th>Hizmet Başlığı</th>
                    <th>Tür</th>
                    ${yearlyYears.map(y => `<th class="col-yearly">${y}</th>`).join('')}
                    ${lastMonthWithData !== null ? monthNames.slice(0, lastMonthWithData + 1).map((m)=>`<th class=\"col-monthly\">${lastYear} ${m}</th>`).join('') : ''}
                    <th class="col-error">Hata Açıklaması</th>
                </tr>`;

                const hizmetSelect = dataCheckerContainer.querySelector('#filter-hizmet');
                const lokasyonSelect = dataCheckerContainer.querySelector('#filter-lokasyon');
                const mudurlukSelect = dataCheckerContainer.querySelector('#filter-mudurluk');
                const onlyErrorsCheckbox = dataCheckerContainer.querySelector('#filter-only-errors');
                const toggleYearly = dataCheckerContainer.querySelector('#toggle-yearly');
                const toggleMonthly = dataCheckerContainer.querySelector('#toggle-monthly');
                const toggleErrorCol = dataCheckerContainer.querySelector('#toggle-error-col');

                function applyFilters(data) {
                    const h = hizmetSelect.value;
                    const l = lokasyonSelect.value;
                    const m = mudurlukSelect.value;
                    return data.filter(r => (h ? r.hizmet === h : true) && (l ? r.lokasyon === l : true) && (m ? r.mudurluk === m : true));
                }

                function groupData(filtered) {
                    // Ana gruplama: Hizmet Başlığı + Tür + Veri Aralığı
                    const groups = new Map();
                    filtered.forEach(r => {
                        const key = `${r.hizmet}||${r.tur}||${r.veriAraligi}`;
                        if (!groups.has(key)) groups.set(key, { hizmet: r.hizmet, tur: r.tur, veriAraligi: r.veriAraligi, byYear: {}, byMonthLastYear: {} });
                        const g = groups.get(key);
                        const y = getYear(r.sonTarih);
                        if (!y) return;
                        g.byYear[y] = (g.byYear[y] || 0) + (r.deger || 0);
                        if (y === lastYear) {
                            const m = getMonthIndex(r.sonTarih); // 0..11
                            if (m !== null) {
                                g.byMonthLastYear[m] = (g.byMonthLastYear[m] || 0) + (r.deger || 0);
                            }
                        }
                    });
                    return Array.from(groups.values());
                }

                // Aynı hizmet + veri aralığı + yıl/ay düzeyinde diğer türlerde >0 iken 0 olanları tespit için özetler
                function buildCrossTypeLookups(filtered) {
                    const yearlyLookup = new Map(); // key: hizmet||veriAraligi||year -> { tur: value }
                    const monthlyLookup = new Map(); // key: hizmet||veriAraligi||month -> { tur: value } (sadece son yıl)
                    filtered.forEach(r => {
                        const y = getYear(r.sonTarih);
                        if (!y) return;
                        const keyYear = `${r.hizmet}||${r.veriAraligi}||${y}`;
                        const bucketYear = yearlyLookup.get(keyYear) || {};
                        bucketYear[r.tur] = (bucketYear[r.tur] || 0) + (r.deger || 0);
                        yearlyLookup.set(keyYear, bucketYear);
                        if (y === lastYear) {
                            const m = getMonthIndex(r.sonTarih);
                            if (m !== null) {
                                const keyMonth = `${r.hizmet}||${r.veriAraligi}||${m}`;
                                const bucketMonth = monthlyLookup.get(keyMonth) || {};
                                bucketMonth[r.tur] = (bucketMonth[r.tur] || 0) + (r.deger || 0);
                                monthlyLookup.set(keyMonth, bucketMonth);
                            }
                        }
                    });

                    // Çatışmalı (0 ve >0 birlikte) kombinasyonlara katkıda bulunan satırları işaretle
                    const yearlyContrib = new Set(); // key: hizmet||veriAraligi||tur||year
                    yearlyLookup.forEach((bucket, key) => {
                        const values = Object.values(bucket);
                        const hasPos = values.some(v => (v || 0) > 0);
                        const hasZero = values.some(v => (v || 0) === 0);
                        if (hasPos && hasZero) {
                            const [hizmet, veriAraligi, year] = key.split('||');
                            Object.entries(bucket).forEach(([tur, _]) => {
                                yearlyContrib.add(`${hizmet}||${veriAraligi}||${tur}||${year}`);
                            });
                        }
                    });

                    const monthlyContrib = new Set(); // key: hizmet||veriAraligi||tur||month
                    monthlyLookup.forEach((bucket, key) => {
                        const values = Object.values(bucket);
                        const hasPos = values.some(v => (v || 0) > 0);
                        const hasZero = values.some(v => (v || 0) === 0);
                        if (hasPos && hasZero) {
                            const [hizmet, veriAraligi, month] = key.split('||');
                            Object.entries(bucket).forEach(([tur, _]) => {
                                monthlyContrib.add(`${hizmet}||${veriAraligi}||${tur}||${month}`);
                            });
                        }
                    });

                    return { yearlyLookup, monthlyLookup, yearlyContrib, monthlyContrib };
                }

                function renderBody() {
                    const tbody = dataCheckerContainer.querySelector('#data-table-body');
                    tbody.innerHTML = '';

                    const filtered = applyFilters(normalized);
                    const groups = groupData(filtered);
                    const { yearlyLookup, monthlyLookup, yearlyContrib, monthlyContrib } = buildCrossTypeLookups(filtered);
                    const monthsCount = (lastMonthWithData !== null ? lastMonthWithData + 1 : 0);
                    const totalCols = 2 + yearlyYears.length + monthsCount + 1; // Hizmet + Tür + yıllık + aylık + hata

                    // Hizmet başlıklarına göre gruplandır, sonra Veri Aralığı alt grupları oluştur
                    const hizmetOrder = [...new Set(groups.map(g => g.hizmet))];
                    hizmetOrder.forEach(hizmetAdi => {
                        const trGroup = document.createElement('tr');
                        trGroup.className = 'group-row';
                        trGroup.innerHTML = `<td colspan="${totalCols}">${hizmetAdi}</td>`;
                        tbody.appendChild(trGroup);
                        let groupRowCount = 0;

                        const veriAralikSirasi = ['AYLIK','BGG','KÜMÜLATİF'];
                        const altGruplar = [...new Set(groups.filter(g => g.hizmet === hizmetAdi).map(g => g.veriAraligi))]
                            .sort((a,b) => (veriAralikSirasi.indexOf(a) === -1 ? 999 : veriAralikSirasi.indexOf(a)) - (veriAralikSirasi.indexOf(b) === -1 ? 999 : veriAralikSirasi.indexOf(b)));

                        altGruplar.forEach(va => {
                            const trSub = document.createElement('tr');
                            trSub.className = 'subgroup-row';
                            trSub.innerHTML = `<td colspan="${totalCols}">${va}</td>`;
                            tbody.appendChild(trSub);
                            let subRowCount = 0;

                            groups.filter(g => g.hizmet === hizmetAdi && g.veriAraligi === va).forEach(g => {
                        const tr = document.createElement('tr');
                        const errorMessages = [];
                        const cells = [];

                        // Metin hücreleri (Hizmet Başlığı, Tür)
                        cells.push(`<td>${g.hizmet}</td>`);
                        cells.push(`<td>${g.tur}</td>`);

                        // Yıllık hücreler (son yıl hariç) + Hata kontrolü
                        let prevCumYearValue = null;
                        let hasErrorInRow = false;
                        yearlyYears.forEach(y => {
                            const val = g.byYear[y] || 0;
                            let cls = '';
                            let tip = '';

                            // Tutarsızlık: aynı hizmet + aynı veri aralığı + aynı yıl içinde, bir türde 0 iken başka bir tür > 0
                            const crossKey = `${g.hizmet}||${g.veriAraligi}||${y}`;
                            const bucket = yearlyLookup.get(crossKey) || {};
                            const hasAnyPositive = Object.values(bucket).some(v => (v || 0) > 0);
                            if (hasAnyPositive && val === 0) {
                                cls = 'risk-inconsistent';
                                hasErrorInRow = true;
                                const positiveList = Object.entries(bucket)
                                    .filter(([t,v]) => t !== g.tur && (v || 0) > 0)
                                    .map(([t,v]) => `${t}=${formatNumber(v)}`)
                                    .join(', ');
                                tip = `Tutarsızlık: Yıl ${y}, Veri Aralığı ${g.veriAraligi}. ${g.tur}=0 iken diğer türlerde değer var -> ${positiveList}`;
                                errorMessages.push(`Tutarsızlık: Yıl ${y}, ${g.tur}=0; Diğer >0: ${positiveList}`);
                            }

                            // Yıllık kolonlarda azalan kontrolü yapılmaz
                            if (false) {
                                if (prevCumYearValue !== null && val < prevCumYearValue) {
                                    cls = cls ? cls + ' risk-decreasing' : 'risk-decreasing';
                                    tip = tip ? tip + ' | ' : '';
                                    tip += 'Azalan Kümülatif: Bir önceki yıldan daha düşük.';
                                    errorMessages.push('Azalan Kümülatif (sarı)');
                                }
                                prevCumYearValue = val;
                            }

                            const content = (g.tur.toLocaleLowerCase('tr-TR').includes('bütçe') ? formatCurrency(val) : formatNumber(val));
                            cells.push(`<td class="col-yearly ${cls}" ${tip ? `title="${tip}"` : ''}>${content}</td>`);
                        });

                        // Son yıl ay bazlı hücreler (yalnızca veri olan son aya kadar)
                        let prevCumMonthValue = null;
                        for (let m = 0; m <= (lastMonthWithData ?? -1); m++) {
                            const val = g.byMonthLastYear[m] || 0;
                            let cls = '';
                            let tip = '';
                            // Tutarsızlık: aynı hizmet + veri aralığı + ay içinde, başka tür >0 iken bu tür 0
                            const crossMonthKey = `${g.hizmet}||${g.veriAraligi}||${m}`;
                            const bucketMonth = monthlyLookup.get(crossMonthKey) || {};
                            const hasAnyPositiveMonth = Object.values(bucketMonth).some(v => (v || 0) > 0);
                            if (hasAnyPositiveMonth && val === 0) {
                                cls = 'risk-inconsistent';
                                hasErrorInRow = true;
                                const positiveListMonth = Object.entries(bucketMonth)
                                    .filter(([t,v]) => t !== g.tur && (v || 0) > 0)
                                    .map(([t,v]) => `${t}=${formatNumber(v)}`)
                                    .join(', ');
                                tip = `Tutarsızlık: ${lastYear} ${monthNames[m]} için ${g.veriAraligi}. ${g.tur}=0; Diğer >0: ${positiveListMonth}`;
                                errorMessages.push(`Tutarsızlık: ${lastYear} ${monthNames[m]}, ${g.tur}=0; Diğer >0: ${positiveListMonth}`);
                            }
                            // Azalan kontrolü: sadece aylık görünümde ve BGG veya KÜMÜLATİF için
                            if (g.veriAraligi === 'KÜMÜLATİF' || g.veriAraligi === 'BGG') {
                                if (prevCumMonthValue !== null && val < prevCumMonthValue) {
                                    cls = cls ? cls + ' risk-decreasing' : 'risk-decreasing';
                                    tip = tip ? tip + ' | ' : '';
                                    tip += `Azalan ${g.veriAraligi}: ${lastYear} ${monthNames[m-1]}=${formatNumber(prevCumMonthValue)} > ${lastYear} ${monthNames[m]}=${formatNumber(val)}`;
                                    errorMessages.push(`Azalan ${g.veriAraligi}: ${lastYear} ${monthNames[m-1]}=${formatNumber(prevCumMonthValue)} > ${lastYear} ${monthNames[m]}=${formatNumber(val)}`);
                                    hasErrorInRow = true;
                                }
                                prevCumMonthValue = val;
                            }
                            const content = (g.tur.toLocaleLowerCase('tr-TR').includes('bütçe') ? formatCurrency(val) : formatNumber(val));
                            cells.push(`<td class="col-monthly ${cls}" ${tip ? `title="${tip}"` : ''}>${content}</td>`);
                        }

                        // Hata açıklaması kolonu
                        const uniqMsgs = Array.from(new Set(errorMessages));
                        cells.push(`<td class="col-error">${uniqMsgs.join(', ')}</td>`);

                        tr.innerHTML = cells.join('');

                        // Sadece hatalıları göster filtresi: satırın kendisi hatalıysa veya hataya katkı sunan (aynı tarih diliminde >0) satırlardan biriyse göster
                        if (onlyErrorsCheckbox.checked) {
                            let isContributor = false;
                            // yıllık
                            for (const y of yearlyYears) {
                                if (yearlyContrib.has(`${g.hizmet}||${g.veriAraligi}||${g.tur}||${y}`)) { isContributor = true; break; }
                            }
                            // aylık (son yıl)
                            if (!isContributor) {
                                for (let m = 0; m <= (lastMonthWithData ?? -1); m++) {
                                    if (monthlyContrib.has(`${g.hizmet}||${g.veriAraligi}||${g.tur}||${m}`)) { isContributor = true; break; }
                                }
                            }
                            if (!(hasErrorInRow || isContributor)) {
                                return;
                            }
                        }

                        tbody.appendChild(tr);
                        subRowCount += 1;
                        groupRowCount += 1;
                            });
                            // Eğer alt grupta hiç satır eklenmediyse alt grup başlığını kaldır
                            if (subRowCount === 0) {
                                tbody.removeChild(trSub);
                            }
                        });
                        // Eğer grupta hiç satır yoksa grup başlığını kaldır
                        if (groupRowCount === 0) {
                            tbody.removeChild(trGroup);
                        }
                    });
                    // Render sonrası sütun görünürlüklerini yeniden uygula
                    applyColumnToggles();
                }

                // Olaylar
                hizmetSelect.addEventListener('change', renderBody);
                lokasyonSelect.addEventListener('change', renderBody);
                mudurlukSelect.addEventListener('change', renderBody);
                onlyErrorsCheckbox.addEventListener('change', renderBody);
                function applyColumnToggles() {
                    const table = dataCheckerContainer.querySelector('#data-table');
                    table.querySelectorAll('.col-yearly').forEach(el => { el.style.display = toggleYearly.checked ? '' : 'none'; });
                    table.querySelectorAll('.col-monthly').forEach(el => { el.style.display = toggleMonthly.checked ? '' : 'none'; });
                    table.querySelectorAll('.col-error').forEach(el => { el.style.display = toggleErrorCol.checked ? '' : 'none'; });
                }
                toggleYearly.addEventListener('change', applyColumnToggles);
                toggleMonthly.addEventListener('change', applyColumnToggles);
                toggleErrorCol.addEventListener('change', applyColumnToggles);

                renderBody();
                applyColumnToggles();
            } catch (err) {
                handleError('Veri kontrol aracı hazırlanırken bir hata oluştu.', err.message);
            }
        }

        // --- AUTH & USER MANAGEMENT ---
        function handleLogin(event) {
            event.preventDefault();
            const username = event.target.username.value.trim();
            const password = event.target.password.value.trim();
            const user = reportUsers.find(u => u.username === username && u.password === password);
            if (user) { sessionStorage.setItem('loggedInUser', JSON.stringify(user)); showAppForUser(user); }
            else { loginError.textContent = 'Kullanıcı adı veya şifre hatalı.'; loginError.classList.remove('hidden'); }
        }

        function showAppForUser(user) {
            loginSection.classList.add('hidden');
            appContainer.classList.remove('hidden');
            header.classList.add('hidden');
            reportContent.classList.add('hidden');
            entryPoint.classList.remove('hidden');
            renderEntryPoint();
        }
        
        // --- Sayfa Yükleme Olayları ---
        window.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (user) { showAppForUser(user); }
            else { loginSection.classList.remove('hidden'); appContainer.classList.add('hidden'); }
        });
        loginForm.addEventListener('submit', handleLogin);
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowRight') changeSlide(1); else if (e.key === 'ArrowLeft') changeSlide(-1); });
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        reportContent.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const { clientX: mouseX, clientY: mouseY } = e;
            contextMenu.style.top = `${mouseY}px`;
            contextMenu.style.left = `${mouseX}px`;
            contextMenu.classList.remove('hidden');
        });

        window.addEventListener('click', () => {
            contextMenu.classList.add('hidden');
        });

        document.getElementById('context-download-pdf').addEventListener('click', () => {
            handlePdfDownload();
            contextMenu.classList.add('hidden');
        });


        async function handlePdfDownload() {
            const { jsPDF } = window.jspdf;
            const slidesToCapture = document.querySelectorAll('.presentation-slide');
            if (slidesToCapture.length === 0) {
                alert("PDF oluşturulacak slayt bulunamadı.");
                return;
            }

            const loadingIndicator = document.createElement('div');
            loadingIndicator.textContent = 'PDF oluşturuluyor, lütfen bekleyin...';
            loadingIndicator.style.position = 'fixed';
            loadingIndicator.style.top = '50%';
            loadingIndicator.style.left = '50%';
            loadingIndicator.style.transform = 'translate(-50%, -50%)';
            loadingIndicator.style.backgroundColor = 'white';
            loadingIndicator.style.padding = '2rem';
            loadingIndicator.style.borderRadius = '12px';
            loadingIndicator.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
            loadingIndicator.style.zIndex = '10001';
            document.body.appendChild(loadingIndicator);
            
            fullscreenBtn.classList.add('hidden');

            const originalSlideIndex = currentSlideIndex;
            try {
                await document.documentElement.requestFullscreen();
                await new Promise(resolve => setTimeout(resolve, 500)); 
                const w = window.screen.width;
                const h = window.screen.height;
                const orientation = w > h ? 'l' : 'p';
                const pdf = new jsPDF(orientation, 'px', [w, h]);
                for (let i = 0; i < slidesToCapture.length; i++) {
                    showSlide(i);
                    await new Promise(resolve => setTimeout(resolve, 1000)); 
                    try {
                        loadingIndicator.classList.add('hidden');
                        const canvas = await html2canvas(document.body, { 
                            scale: 2, 
                            useCORS: true, 
                            width: w, 
                            height: h, 
                            windowWidth: w, 
                            windowHeight: h, 
                            x: 0, 
                            y: 0 
                        });
                        loadingIndicator.classList.remove('hidden');
                        const imgData = canvas.toDataURL('image/jpeg', 0.9);
                        if (i > 0) { pdf.addPage([w, h], orientation); }
                        pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
                    } catch (error) { console.error(`Slayt ${i+1} işlenirken hata oluştu:`, error); }
                }
                pdf.save('rapor.pdf');
            } catch(err) {
                 alert('Tam ekran moduna geçilemedi veya bir hata oluştu.');
                 console.error(err);
            } finally {
                if (document.fullscreenElement) { await document.exitFullscreen(); }
                showSlide(originalSlideIndex); 
                document.body.removeChild(loadingIndicator);
                fullscreenBtn.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
